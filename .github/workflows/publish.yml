name: Publish Post

on:
  workflow_dispatch:
    inputs:
      title:
        description: 'Post title'
        required: true
        type: string
      slug:
        description: 'URL slug'
        required: true
        type: string
      content:
        description: 'Markdown content'
        required: true
        type: string
      tags:
        description: 'JSON array of tags'
        required: false
        default: '[]'
        type: string
      status:
        description: 'Post status (published or draft)'
        required: true
        default: 'published'
        type: string
      publish_date:
        description: 'Publish date (YYYY-MM-DD)'
        required: true
        type: string
      author:
        description: 'Author name'
        required: false
        default: 'Admin'
        type: string

permissions:
  contents: write
  actions: write

jobs:
  publish:
    runs-on: ubuntu-latest
    env:
      INPUT_TITLE: ${{ github.event.inputs.title }}
      INPUT_SLUG: ${{ github.event.inputs.slug }}
      INPUT_CONTENT: ${{ github.event.inputs.content }}
      INPUT_TAGS: ${{ github.event.inputs.tags }}
      INPUT_STATUS: ${{ github.event.inputs.status }}
      INPUT_DATE: ${{ github.event.inputs.publish_date }}
      INPUT_AUTHOR: ${{ github.event.inputs.author }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create post file
        run: |
          # Determine output status and directory
          STATUS="${INPUT_STATUS}"
          DIR="posts"

          # If status is draft, put in drafts folder
          if [ "$STATUS" = "draft" ]; then
            DIR="posts/drafts"
          fi

          # If publish date is in the future and status is published, schedule it
          TODAY=$(date +%Y-%m-%d)
          if [[ "$INPUT_DATE" > "$TODAY" && "$STATUS" == "published" ]]; then
            STATUS="scheduled"
            DIR="posts/drafts"
          fi

          mkdir -p "$DIR"

          FILENAME="${INPUT_DATE}-${INPUT_SLUG}.md"
          FILEPATH="${DIR}/${FILENAME}"

          # Write frontmatter
          {
            echo "---"
            echo "title: \"${INPUT_TITLE}\""
            echo "slug: \"${INPUT_SLUG}\""
            echo "author: \"${INPUT_AUTHOR}\""
            echo "date: \"${INPUT_DATE}\""
            echo "tags: ${INPUT_TAGS}"
            echo "status: \"${STATUS}\""
            echo "---"
            echo ""
          } > "$FILEPATH"

          # Append content
          echo "${INPUT_CONTENT}" >> "$FILEPATH"

          echo "‚úÖ Created file: $FILEPATH"
          echo "   Status: $STATUS"
          echo "   Directory: $DIR"
          cat "$FILEPATH"

      - name: Commit and push
        run: |
          git config user.name "Blog Bot"
          git config user.email "bot@blog.github.io"
          git add posts/
          git diff --cached --quiet && echo "No changes to commit" && exit 0
          git commit -m "üìù ${INPUT_STATUS}: ${INPUT_TITLE}"
          git push

      - name: Trigger deploy workflow
        run: |
          curl -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/deploy.yml/dispatches \
            -d '{"ref":"main"}'
          echo "üöÄ Deploy workflow triggered!"
